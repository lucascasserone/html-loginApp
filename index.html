<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CorpSystem | Gest√£o Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        [x-cloak] { display: none !important; }
        .bg-corporate { background-color: #003366; }
        .text-corporate { color: #003366; }
    </style>
</head>
<body class="bg-gray-50 font-sans" x-data="systemAuth()">

    <div x-show="view === 'login'" x-cloak class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-xl shadow-2xl w-full max-w-md border-t-8 border-[#003366]">
            <h2 class="text-3xl font-extrabold text-[#003366] text-center mb-8 uppercase">Login</h2>
            <form @submit.prevent="handleLogin">
                <input type="email" x-model="email" placeholder="E-mail" class="w-full px-4 py-3 border-2 rounded-lg mb-4 outline-none focus:border-blue-500">
                <input type="password" x-model="password" placeholder="Senha" class="w-full px-4 py-3 border-2 rounded-lg mb-6 outline-none focus:border-blue-500">
                <button type="submit" class="w-full bg-[#003366] text-white py-3 rounded-lg font-bold hover:brightness-110 transition">ACESSAR</button>
            </form>
        </div>
    </div>

    <div x-show="view === 'dashboard'" x-cloak class="min-h-screen flex flex-col">
        <nav class="bg-corporate text-white px-8 py-4 flex justify-between items-center shadow-xl">
            <div class="flex items-center gap-6">
                <span class="font-black text-xl tracking-tighter italic">CORP<span class="font-light">SYS</span></span>
                <div class="flex gap-4 ml-6">
                    <button @click="tab = 'users'" :class="tab === 'users' ? 'border-b-2 border-white' : 'opacity-50'" class="pb-1 text-sm font-bold uppercase transition">Usu√°rios</button>
                    <template x-if="userRole === 'Administrador'">
                        <button @click="tab = 'roles'" :class="tab === 'roles' ? 'border-b-2 border-white' : 'opacity-50'" class="pb-1 text-sm font-bold uppercase transition">Configura√ß√µes</button>
                    </template>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-xs bg-white/10 px-3 py-1 rounded-full uppercase font-bold" x-text="userRole"></span>
                <button @click="handleLogout" class="bg-red-600 hover:bg-red-700 px-4 py-1.5 rounded-lg text-xs font-bold transition-all shadow-lg active:scale-95">Sair do Sistema</button>
            </div>
        </nav>

        <main class="p-8 max-w-6xl mx-auto w-full">
            <div x-show="tab === 'users'">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-gray-400 text-xs font-bold uppercase">Total na Base</p>
                        <p class="text-4xl font-black text-gray-800" x-text="totalUsers"></p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-green-500 md:col-span-2">
                        <p class="text-gray-400 text-xs font-bold uppercase">Seu Acesso</p>
                        <p class="text-xl font-bold text-gray-800">Voc√™ est√° logado como <span class="text-blue-600" x-text="userRole"></span></p>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border p-10" x-show="userRole !== 'Visualizador'">
                    <h3 class="font-bold text-lg mb-4">üì• Importa√ß√£o em Massa</h3>
                    <div class="border-4 border-dashed border-gray-100 rounded-2xl p-12 text-center hover:border-[#003366] transition relative">
                        <input type="file" @change="handleExcelUpload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <p class="text-gray-500">Arraste seu arquivo de colaboradores aqui</p>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-yellow-50 text-yellow-800 rounded-lg text-sm" x-show="userRole === 'Visualizador'">
                    ‚ö†Ô∏è Seu perfil possui apenas permiss√£o de <b>leitura</b>. O upload de arquivos est√° desativado.
                </div>
            </div>

            <div x-show="tab === 'roles'" class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 font-bold text-xs uppercase text-gray-400">
                        <tr>
                            <th class="p-4">Perfil</th>
                            <th class="p-4">Pode Importar?</th>
                            <th class="p-4">Pode Deletar?</th>
                            <th class="p-4">Pode Gerenciar Roles?</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y text-sm">
                        <tr>
                            <td class="p-4 font-bold">Administrador</td>
                            <td class="p-4 text-green-600">Sim</td>
                            <td class="p-4 text-green-600">Sim</td>
                            <td class="p-4 text-green-600">Sim</td>
                        </tr>
                        <tr>
                            <td class="p-4 font-bold">Colaborador</td>
                            <td class="p-4 text-green-600">Sim</td>
                            <td class="p-4 text-red-600">N√£o</td>
                            <td class="p-4 text-red-600">N√£o</td>
                        </tr>
                        <tr>
                            <td class="p-4 font-bold">Visualizador</td>
                            <td class="p-4 text-red-600">N√£o</td>
                            <td class="p-4 text-red-600">N√£o</td>
                            <td class="p-4 text-red-600">N√£o</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        const SUPABASE_URL = 'https://nqdlxiyzsxkntypyzkie.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZGx4aXl6c3hrbnR5cHl6a2llIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjY1ODIsImV4cCI6MjA4NzU0MjU4Mn0.8npxzHMR3VdaufiqmsJKdLR2zpXDOFzDldFwdth18f0';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function systemAuth() {
            return {
                view: 'login',
                tab: 'users',
                loading: false,
                email: '',
                password: '',
                userEmail: '',
                userRole: 'Visualizador', // Default
                totalUsers: 0,

                async init() {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session) {
                        this.userEmail = session.user.email;
                        this.view = 'dashboard';
                        await this.fetchUserRole();
                        await this.updateCounters();
                    }
                },

                async fetchUserRole() {
                    // Busca na sua acessTable qual o cargo deste email
                    const { data, error } = await supabaseClient
                        .from('acessTable')
                        .select('cargo')
                        .eq('email', this.userEmail)
                        .single();
                    
                    if (data) {
                        // Mapeia cargos do banco para roles do sistema
                        if (data.cargo === 'CEO' || data.cargo === 'Diretor') this.userRole = 'Administrador';
                        else if (data.cargo === 'Gerente') this.userRole = 'Colaborador';
                        else this.userRole = 'Visualizador';
                    }
                },

                async updateCounters() {
                    const { count, error } = await supabaseClient
                        .from('acessTable')
                        .select('*', { count: 'exact', head: true });
                    this.totalUsers = count || 0;
                },

                async handleLogin() {
                    this.loading = true;
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: this.email,
                        password: this.password,
                    });

                    if (error) {
                        Swal.fire('Erro', 'Verifique suas credenciais.', 'error');
                    } else {
                        window.location.reload(); // Recarrega para rodar o init()
                    }
                    this.loading = false;
                },

                async handleLogout() {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) console.error(error);
                    window.location.href = window.location.pathname; // For√ßa retorno √† URL limpa
                },

                handleExcelUpload(e) {
                    if (this.userRole === 'Visualizador') {
                        Swal.fire('Bloqueado', 'Voc√™ n√£o tem permiss√£o para upload.', 'warning');
                        return;
                    }
                    // L√≥gica de leitura do excel...
                    Swal.fire('Sucesso', 'Arquivo lido com sucesso!', 'success');
                }
            }
        }
    </script>
</body>
</html>

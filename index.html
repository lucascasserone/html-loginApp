<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CorpSystem | Advanced Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        [x-cloak] { display: none !important; }
        .bg-corporate { background-color: #003366; }
        .text-corporate { color: #003366; }
        .border-corporate { border-color: #003366; }
    </style>
</head>
<body class="bg-gray-50 font-sans" x-data="systemAuth()">

    <div x-show="view === 'login'" x-cloak class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-xl shadow-2xl w-full max-w-md border-t-8 border-corporate">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-extrabold text-corporate uppercase tracking-tighter">Login</h2>
                <p class="text-gray-400 mt-2">Gest√£o de Acessos Corporativos</p>
            </div>
            <form @submit.prevent="handleLogin">
                <div class="mb-5">
                    <label class="block text-sm font-bold text-gray-700 mb-2">E-mail</label>
                    <input type="email" x-model="email" required class="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 outline-none transition">
                </div>
                <div class="mb-2">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Senha</label>
                    <input type="password" x-model="password" required class="w-full px-4 py-3 border-2 rounded-lg focus:border-blue-500 outline-none transition">
                </div>
                <div class="text-right mb-6">
                    <button type="button" @click="view = 'recover'" class="text-xs font-semibold text-blue-600 hover:underline">Esqueceu sua senha?</button>
                </div>
                <button type="submit" :disabled="loading" class="w-full bg-corporate text-white py-3 rounded-lg font-bold hover:brightness-125 transition flex justify-center items-center shadow-lg">
                    <span x-show="!loading">ENTRAR</span>
                    <div x-show="loading" class="animate-spin border-4 border-white border-t-transparent rounded-full w-6 h-6"></div>
                </button>
            </form>
        </div>
    </div>

    <div x-show="view === 'recover'" x-cloak class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-corporate mb-2">Recuperar Senha</h2>
            <p class="text-sm text-gray-500 mb-6">Enviaremos um link seguro para o seu e-mail.</p>
            <input type="email" x-model="email" class="w-full px-4 py-3 border-2 rounded-lg mb-4 outline-none focus:border-blue-500" placeholder="Seu e-mail">
            <button @click="handleRecovery" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-black transition mb-4">ENVIAR LINK</button>
            <button @click="view = 'login'" class="w-full text-sm font-bold text-gray-400 hover:text-gray-600 transition">VOLTAR</button>
        </div>
    </div>

    <div x-show="view === 'reset_password'" x-cloak class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-xl shadow-2xl w-full max-w-md border-t-8 border-green-600">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Nova Senha</h2>
            <p class="text-sm text-gray-500 mb-6">Digite sua nova senha de acesso.</p>
            <input type="password" x-model="newPassword" class="w-full px-4 py-3 border-2 rounded-lg mb-4 outline-none focus:border-green-600" placeholder="Nova Senha">
            <button @click="handleUpdatePassword" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition">ATUALIZAR E LOGAR</button>
        </div>
    </div>

    <div x-show="view === 'dashboard'" x-cloak class="min-h-screen flex flex-col">
        <nav class="bg-corporate text-white px-8 py-4 flex justify-between items-center shadow-xl">
            <div class="flex items-center gap-4">
                <span class="font-black text-xl tracking-tighter">CORP<span class="font-light">SYS</span></span>
                <div class="h-6 w-px bg-white/20 mx-2"></div>
                <button @click="tab = 'users'" :class="tab === 'users' ? 'text-white' : 'text-white/50'" class="text-sm font-bold uppercase hover:text-white transition">Usu√°rios</button>
                <button @click="tab = 'roles'" :class="tab === 'roles' ? 'text-white' : 'text-white/50'" class="text-sm font-bold uppercase hover:text-white transition">Permiss√µes</button>
            </div>
            <div class="flex items-center gap-6">
                <span class="text-xs bg-white/10 px-3 py-1 rounded-full border border-white/20" x-text="userEmail"></span>
                <button @click="handleLogout" class="bg-red-500 hover:bg-red-600 px-4 py-1.5 rounded-lg text-xs font-bold transition">Sair</button>
            </div>
        </nav>

        <main class="p-8 max-w-6xl mx-auto w-full flex-grow">
            <div x-show="tab === 'users'" x-transition>
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h1 class="text-2xl font-black text-gray-800">Carga de Colaboradores</h1>
                        <p class="text-sm text-gray-500">Importa√ß√£o massiva e gest√£o de cadastro</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="md:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 p-10">
                        <div class="border-4 border-dashed border-gray-100 rounded-2xl p-12 text-center hover:border-corporate transition-all group relative">
                            <input type="file" @change="handleExcelUpload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            <div class="text-4xl mb-4">üìÑ</div>
                            <p class="text-gray-600 font-bold">Solte o arquivo .XLSX aqui</p>
                            <p class="text-xs text-gray-400 mt-2">O sistema processar√° nome, e-mail e setor automaticamente.</p>
                        </div>
                    </div>
                    <div class="bg-corporate text-white rounded-2xl p-8 shadow-lg flex flex-col justify-center">
                        <p class="text-xs font-bold opacity-60 uppercase mb-2">Total na Base</p>
                        <p class="text-5xl font-black mb-4">124</p>
                        <p class="text-xs leading-relaxed opacity-80">Novos usu√°rios importados via Excel recebem convite de ativa√ß√£o por e-mail.</p>
                    </div>
                </div>
            </div>

            <div x-show="tab === 'roles'" x-transition>
                <div class="mb-8">
                    <h1 class="text-2xl font-black text-gray-800">Matriz de Permiss√µes</h1>
                    <p class="text-sm text-gray-500">Configure os n√≠veis de acesso de cada cargo</p>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-100">
                                <th class="p-4 text-xs font-bold text-gray-400 uppercase">Role / N√≠vel</th>
                                <th class="p-4 text-xs font-bold text-gray-400 uppercase">Acesso Financeiro</th>
                                <th class="p-4 text-xs font-bold text-gray-400 uppercase">Gest√£o RH</th>
                                <th class="p-4 text-xs font-bold text-gray-400 uppercase">Carga Excel</th>
                                <th class="p-4 text-xs font-bold text-gray-400 uppercase text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50">
                            <template x-for="role in rolesList">
                                <tr class="hover:bg-gray-50/50 transition">
                                    <td class="p-4">
                                        <p class="font-bold text-gray-800" x-text="role.name"></p>
                                        <p class="text-[10px] text-gray-400 font-mono" x-text="role.id"></p>
                                    </td>
                                    <td class="p-4"><input type="checkbox" :checked="role.finance" class="rounded text-corporate"></td>
                                    <td class="p-4"><input type="checkbox" :checked="role.rh" class="rounded text-corporate"></td>
                                    <td class="p-4"><input type="checkbox" :checked="role.excel" class="rounded text-corporate"></td>
                                    <td class="p-4 text-center">
                                        <button class="text-[10px] font-black bg-gray-100 hover:bg-corporate hover:text-white px-3 py-1 rounded-full transition uppercase">Editar</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SUPABASE_URL = 'https://nqdlxiyzsxkntypyzkie.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZGx4aXl6c3hrbnR5cHl6a2llIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NjY1ODIsImV4cCI6MjA4NzU0MjU4Mn0.8npxzHMR3VdaufiqmsJKdLR2zpXDOFzDldFwdth18f0';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function systemAuth() {
            return {
                view: 'login',
                tab: 'users',
                loading: false,
                email: '',
                password: '',
                newPassword: '',
                userEmail: '',
                rolesList: [
                    { id: 'RL-001', name: 'Administrador Master', finance: true, rh: true, excel: true },
                    { id: 'RL-002', name: 'Gestor de Opera√ß√µes', finance: false, rh: true, excel: true },
                    { id: 'RL-003', name: 'Analista Pleno', finance: false, rh: false, excel: true },
                    { id: 'RL-004', name: 'Visualizador P√∫blico', finance: false, rh: false, excel: false }
                ],

                async init() {
                    // Check for password recovery token in URL
                    if (window.location.hash.includes('type=recovery')) {
                        this.view = 'reset_password';
                        return;
                    }

                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session) {
                        this.userEmail = session.user.email;
                        this.view = 'dashboard';
                    }
                },

                async handleLogin() {
                    this.loading = true;
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: this.email,
                        password: this.password,
                    });
                    if (error) {
                        this.notify('Falha', error.message, 'error');
                    } else {
                        this.userEmail = data.user.email;
                        this.view = 'dashboard';
                    }
                    this.loading = false;
                },

                async handleRecovery() {
                    const { error } = await supabaseClient.auth.resetPasswordForEmail(this.email, {
                        redirectTo: window.location.href,
                    });
                    if (error) this.notify('Erro', error.message, 'error');
                    else this.notify('E-mail enviado!', 'Confira sua caixa de entrada.', 'success');
                },

                async handleUpdatePassword() {
                    const { error } = await supabaseClient.auth.updateUser({ password: this.newPassword });
                    if (error) this.notify('Erro', error.message, 'error');
                    else {
                        this.notify('Sucesso!', 'Senha alterada. Fa√ßa login.', 'success');
                        this.view = 'login';
                        window.location.hash = ''; // Clear token from URL
                    }
                },

                handleExcelUpload(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        Swal.fire('Importa√ß√£o', `${data.length} registros processados para a fila de convites.`, 'info');
                    };
                    reader.readAsBinaryString(file);
                },

                handleLogout() {
                    supabaseClient.auth.signOut();
                    window.location.reload();
                },

                notify(title, text, icon) {
                    Swal.fire({ title, text, icon, confirmButtonColor: '#003366' });
                }
            }
        }
    </script>
</body>
</html>
